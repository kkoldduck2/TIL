# 스프링 빈과 싱글톤

- 스프링 빈은 기본적으로 싱글톤이다.
    - cf_ 빈 스코프를 프로토 타입으로 변경하면 호출 시 마다 새로운 객체(빈)을 생성한다.

- 싱글톤의 문제점
    - 정확히는 싱글톤 객체 안에 필드가 존재하고, 이 필드를 여러 쓰레드가 접근해서 값을 변경할 때 “동시성 문제”가 발생한다.

- 동시성 문제
    - 여러 쓰레드가 동시에 같은 인스턴스의 필드 값을 변경하면서 발생하는 문제를 동시성 문제라 한다. 이런 동시성 문제는 여러 쓰레드가 같은 인스턴스의 필드에 접근해야 하기 때문에 트래픽이 많아질 수록 자주 발생한다.
    - 특히 스프링 빈 처럼 싱글톤 객체의 필드를 변경하며 사용할 때 이러한 동시성 문제를 조심해야 한다.

> 이런 동시성 문제는 지역 변수에서는 발생하지 않는다. 지역 변수는 쓰레드마다 각각 다른 메모리 영역이 할당되기 때문이다. 

동시성 문제가 발생하는 곳은 같은 인스턴스의 필드(주로 싱글톤에서 자주 발생), 또는 static 같은 공용 필드에 접근할 때 발생한다. 

동시성 문제는 값을 읽기만 하면 발생하지 않는다. 어디선가 값을 변경하기 때문에 발생한다.
> 

그렇다면 싱글톤 객체의 필드를 사용하면서 동시성 문제를 해결하려면 어떻게 해야할까? 이럴 때 사용하는 것이 쓰레드 로컬이다. 

- 해결 방안 : “쓰레드 로컬”

# Thread local

- 쓰레드 로컬을 사용하면 각 쓰레드마다 별도의 내부 저장소를 제공한다. 따라서 같은 인스턴스의 쓰레드 로컬 필드에 접근해도 문제 없다.

![image](https://user-images.githubusercontent.com/47748246/153133736-9a7fbe5f-7844-46d2-aec7-bf168638762f.png)

![image](https://user-images.githubusercontent.com/47748246/153133767-71f7a8cc-1fbb-47b6-9fbf-1512c608b9c9.png)


- 쓰레드 로컬 덕분에 쓰레드 마다 각각 별도의 데이터 저장소를 가지게 되었다. 결과적으로 동시성 문제도 해결되었다.
